- name: Installer AD DS
  win_feature:
    name: AD-Domain-Services
    state: present
    include_management_tools: yes

- name: Promouvoir le serveur en contrôleur de domaine
  win_domain:
    dns_domain_name: "{{ domain_name }}"
    domain_netbios_name: "{{ domain_netbios }}"
    safe_mode_password: "{{ safe_mode_password }}"
    state: domain_controller
  register: ad_result

- name: Redémarrer après promotion AD
  win_reboot:
  when: ad_result.reboot_required

- name: Installer LAPS
  win_feature:
    name: RSAT-AD-PowerShell
    state: present

- name: Désactiver le compte Invité
  win_user:
    name: Guest
    state: absent

- name: Activer le pare-feu Windows
  win_firewall:
    state: enabled
    profiles:
      - Domain
      - Private
      - Public

- name: Politique mot de passe stricte
  win_security_policy:
    section: System Access
    key: MinimumPasswordLength
    value: 12

- name: Activer la complexité des mots de passe
  win_security_policy:
    section: System Access
    key: PasswordComplexity
    value: 1

- name: Désactiver SMBv1
  win_optional_feature:
    name: SMB1Protocol
    state: absent

- name: Désactiver LLMNR
  win_regedit:
    path: HKLM:\Software\Policies\Microsoft\Windows NT\DNSClient
    name: EnableMulticast
    data: 0
    type: dword
